name: Deploy to Azure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: false
        default: 'production'
env:
  DOTNET_VERSON: '8.0.x'
  TERRAFORM_VERSION: '1.5.0'
  ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSON }}
      
    - name: Azure Login
      uses: azure/login@v1
      with:
       creds: '{"clienId":"${{ secrets.ARM_CLIENT_ID }}","clientSecret":"${{ secrets.ARM_CLIENT_SECRET }}","subscriptionId":"${{ secrets.ARM_SUBSCRIPTION_ID }}","tenantId":"${{ secrets.ARM_TENANT_ID }}"}'

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TERRAFORM_VERSION }}
        terraform_wrapper: false

    - name: Terraform Init
      working-directory: ./terraform
      run: terraform init 

    - name: Terraform Format Check
      working-directory: ./terraform
      run: terraform fmt -check 
      continue-on-error: true
    
    - name: Terraform Validate
      working-directory: ./terraform
      run: terraform validate 

    - name: Terraform Plan
      working-directory: ./terraform
      run: |
        terraform plan \
          -var="sub_id=${{ secrets.ARM_SUBSCRIPTION_ID }}" \
          -var="client_id=${{ secrets.ARM_CLIENT_ID }}" \
          -var="client_secret=${{ secrets.ARM_CLIENT_SECRET }}" \
          -var="tenant_id=${{ secrets.ARM_TENANT_ID }}" \
          -out=tfplan

    - name: Terraform Apply
      working-directory: ./terraform
      run: |
        terraform apply \
          -var="sub_id=${{ secrets.ARM_SUBSCRIPTION_ID }}" \
          -var="client_id=${{ secrets.ARM_CLIENT_ID }}" \
          -var="client_secret=${{ secrets.ARM_CLIENT_SECRET }}" \
          -var="tenant_id=${{ secrets.ARM_TENANT_ID }}" \
          -auto-approve \
          tfplan

    - name: Get App Service Name 
      id: terraform-output
      working-directory: ./terraform
      run: |
        APP_NAME=$(terraform output -raw app_service_name)
        APP_URL=$(terraform output -raw app_service_url)
        echo "app_name=${APP_NAME}" >> $GITHUB_OUTPUT
        echo "app_url=${APP_URL}" >> $GITHUB_OUTPUT
      
    - name: Build .NET Application
      working-directory: ./src/AjgPlatformTest
      run: |
        dotnet restore
        dotnet build --configuration Release --no-restore
        dotnet publish --configuration Release --output ./publish --no-build

    - name: Deploy to Azure App Service
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ steps.terraform-output.outputs.app_name }}
        package: ./src/AjgPlatformTest/publish

    - name: Wait for App Service to be ready
      run: |
        echo "Waiting for app service to be ready..."
        sleep 30

    - name: Validate Health Endpoint
      run: |
        APP_URL="${{ steps.terraform-output.outputs.app_url }}"
        echo "Testing health endpoint at ${APP_URL}/health"
        
        for i in {1..10}; do
          if curl -f -s "${APP_URL}/health"; then
            echo "Health check passed"
            break
          else
            echo "Attempt $i failed, retrying in 10 seconds..."
            sleep 10
          fi
          
          if [ $i -eq 10 ]; then
            echo "Health check failed after 10 attempts"
            exit 1
          fi
        done

    - name: Validate Calculate Endpoint
      run: |
        APP_URL="${{ steps.terraform-output.outputs.app_url }}"
        echo "Testing calculate endpoint at ${APP_URL}/calculate?a=5&b=3"
        
        RESULT=$(curl -f -s "${APP_URL}/calculate?a=5&b=3")
        if [ "$RESULT" -eq 8 ]; then
          echo "Calculate endpoint working correctly (5 + 3 = $RESULT)"
        else
          echo "Calculate endpoint returned unexpected result: $RESULT"
          exit 1
        fi

    - name: Deployment Summary
      run: |
        echo "Deployment completed successfully!"
        echo "App URL: ${{ steps.terraform-output.outputs.app_url }}"
        echo "Health Check: ${{ steps.terraform-output.outputs.app_url }}/health"
        echo "Calculate: ${{ steps.terraform-output.outputs.app_url }}/calculate?a=5&b=3"


